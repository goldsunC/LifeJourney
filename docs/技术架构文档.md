# LifeJourney 技术架构文档

## 📋 文档信息

- **项目名称**: LifeJourney
- **版本**: v1.0
- **创建日期**: 2025年10月
- **最后更新**: 2025年10月
- **文档类型**: 技术架构文档
- **架构师**: 开发团队

## 🏗️ 系统架构概述

### 整体架构
LifeJourney 采用现代化的前后端分离架构，基于微服务设计理念，使用Vue3作为前端框架，Spring Boot作为后端框架，确保系统的可扩展性、可维护性和高性能。

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用层     │    │   后端服务层      │    │   数据存储层      │
│                 │    │                 │    │                 │
│  Vue3 SPA       │◄──►│  Spring Boot    │◄──►│   MySQL         │
│  Vite           │    │  Java 21        │    │   Redis Cache   │
│  TypeScript     │    │  Maven          │    │   MinIO         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 架构原则
- **前后端分离**: 前端专注于用户界面，后端专注于业务逻辑
- **RESTful API**: 标准化的API接口设计
- **微服务架构**: 模块化的服务设计
- **云原生**: 支持容器化部署和云服务
- **安全优先**: 多层次的安全防护机制

## 🛠️ 技术栈选择

### 前端技术栈

#### 核心框架
- **Vue 3.4+**: 渐进式JavaScript框架
- **TypeScript 5.0+**: 类型安全的JavaScript
- **Vite 5.0+**: 下一代前端构建工具
- **Pinia**: Vue 3状态管理库

#### UI组件库
- **Element Plus**: 基于Vue 3的组件库
- **VueUse**: Vue 3组合式API工具集

#### 路由和状态管理
- **Vue Router 4**: Vue.js官方路由管理器
- **Pinia**: 轻量级状态管理库
- **Axios**: HTTP客户端库

#### 开发工具
- **ESLint**: 代码质量检查
- **Prettier**: 代码格式化
- **Husky**: Git钩子管理
- **Vitest**: 单元测试框架

### 后端技术栈

#### 核心框架
- **Spring Boot 3.2+**: Java企业级应用框架
- **Java 21**: 最新LTS版本
- **Spring Security**: 安全框架
- **MyBatis-Plus**: 增强的MyBatis框架

#### 数据库和存储
- **MySQL 8.0+**: 主数据库
- **Redis 7+**: 缓存和会话存储
- **MinIO**: 对象存储（文件上传）

#### 认证和安全
- **JWT**: 身份认证
- **BCrypt**: 密码加密
- **Spring Security**: 安全中间件
- **Rate Limiter**: 请求限流

#### 开发工具
- **Maven**: 项目构建工具
- **JUnit 5**: 单元测试
- **Mockito**: 测试模拟框架
- **Spring Boot Test**: 集成测试

### 基础设施

#### 容器化
- **Docker**: 容器化技术
- **Docker Compose**: 本地开发环境

#### 开发工具
- **IntelliJ IDEA**: Java开发IDE
- **VS Code**: 前端开发IDE
- **Postman**: API测试工具

## 🗄️ 数据库设计

### 数据库选择
- **主数据库**: MySQL 8.0
- **缓存数据库**: Redis
- **文件存储**: MinIO

### 核心数据表设计

#### 用户表 (users)
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    display_name VARCHAR(100),
    avatar_url TEXT,
    bio TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 时间线事件表 (timeline_events)
```sql
CREATE TABLE timeline_events (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    event_date DATE NOT NULL,
    event_type VARCHAR(50) NOT NULL,
    category VARCHAR(50),
    status VARCHAR(20) DEFAULT 'completed',
    image_url TEXT,
    metadata JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 文章表 (articles)
```sql
CREATE TABLE articles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    excerpt TEXT,
    slug VARCHAR(200) UNIQUE NOT NULL,
    status VARCHAR(20) DEFAULT 'draft',
    featured_image TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    published_at TIMESTAMP NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 相册表 (albums)
```sql
CREATE TABLE albums (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    cover_image TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 照片表 (photos)
```sql
CREATE TABLE photos (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    album_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    filename VARCHAR(255) NOT NULL,
    original_name VARCHAR(255),
    file_path TEXT NOT NULL,
    file_size BIGINT,
    mime_type VARCHAR(100),
    width INT,
    height INT,
    title VARCHAR(200),
    description TEXT,
    taken_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (album_id) REFERENCES albums(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 目标表 (goals)
```sql
CREATE TABLE goals (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    category VARCHAR(50),
    priority VARCHAR(20) DEFAULT 'medium',
    status VARCHAR(20) DEFAULT 'active',
    target_date DATE,
    completed_at TIMESTAMP NULL,
    progress INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### 标签表 (tags)
```sql
CREATE TABLE tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) UNIQUE NOT NULL,
    color VARCHAR(7),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 文章标签关联表 (article_tags)
```sql
CREATE TABLE article_tags (
    article_id BIGINT NOT NULL,
    tag_id BIGINT NOT NULL,
    PRIMARY KEY (article_id, tag_id),
    FOREIGN KEY (article_id) REFERENCES articles(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);
```

### 数据库索引设计
```sql
-- 用户表索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);

-- 时间线事件索引
CREATE INDEX idx_timeline_events_user_id ON timeline_events(user_id);
CREATE INDEX idx_timeline_events_date ON timeline_events(event_date);
CREATE INDEX idx_timeline_events_type ON timeline_events(event_type);

-- 文章索引
CREATE INDEX idx_articles_user_id ON articles(user_id);
CREATE INDEX idx_articles_status ON articles(status);
CREATE INDEX idx_articles_slug ON articles(slug);
CREATE INDEX idx_articles_published_at ON articles(published_at);

-- 相册索引
CREATE INDEX idx_albums_user_id ON albums(user_id);

-- 照片索引
CREATE INDEX idx_photos_album_id ON photos(album_id);
CREATE INDEX idx_photos_user_id ON photos(user_id);

-- 目标索引
CREATE INDEX idx_goals_user_id ON goals(user_id);
CREATE INDEX idx_goals_status ON goals(status);
CREATE INDEX idx_goals_category ON goals(category);
```

## 🔌 API设计

### RESTful API规范

#### 基础URL
```
https://api.lifejourney.com/v1
```

#### 认证方式
```
Authorization: Bearer <JWT_TOKEN>
```

#### 通用响应格式
```json
{
    "success": true,
    "data": {},
    "message": "操作成功",
    "timestamp": "2025-10-01T10:00:00Z"
}
```

### Spring Boot项目结构

```
src/main/java/org/kangning/lifejourney/
├── LifeJourneyApplication.java
├── config/                    # 配置类
│   ├── SecurityConfig.java
│   ├── RedisConfig.java
│   ├── MinioConfig.java
│   └── WebConfig.java
├── controller/                # 控制器层
│   ├── AuthController.java
│   ├── TimelineController.java
│   ├── ArticleController.java
│   ├── AlbumController.java
│   └── GoalController.java
├── service/                   # 服务层
│   ├── impl/
│   │   ├── AuthServiceImpl.java
│   │   ├── TimelineServiceImpl.java
│   │   └── ArticleServiceImpl.java
│   ├── AuthService.java
│   ├── TimelineService.java
│   └── ArticleService.java
├── mapper/                    # MyBatis-Plus映射器
│   ├── UserMapper.java
│   ├── TimelineEventMapper.java
│   └── ArticleMapper.java
├── entity/                    # 实体类
│   ├── User.java
│   ├── TimelineEvent.java
│   └── Article.java
├── dto/                       # 数据传输对象
│   ├── request/
│   │   ├── LoginRequest.java
│   │   ├── RegisterRequest.java
│   │   └── RefreshTokenRequest.java
│   └── response/
│       ├── AuthResponse.java
│       └── BaseResponse.java
├── exception/                 # 异常处理
│   ├── GlobalExceptionHandler.java
│   ├── BusinessException.java
│   └── ErrorEnum.java
└── util/                      # 工具类
    ├── JwtUtils.java
    └── MinioUtil.java
```

## 🔒 安全架构

### 认证和授权
- **JWT Token**: 无状态身份认证，AccessToken有效期为24小时
- **Refresh Token**: 长期身份验证，用于刷新AccessToken
- **Token存储**: AccessToken存储在Redis中，支持主动失效和单点登录
- **Spring Security**: 基于角色的访问控制
- **API Rate Limiting**: API请求频率限制
- **密码策略**: 密码加密使用BCrypt算法，支持密码强度校验
- **账号锁定**: 登录失败次数超过限制时自动锁定账号

### 认证流程详解

#### 用户注册流程
1. 用户提交注册请求（用户名、邮箱、密码、显示名称）
2. 系统检查用户名和邮箱是否已存在
3. 使用BCrypt加密密码
4. 创建用户记录并保存到数据库
5. 生成JWT AccessToken和RefreshToken
6. 将AccessToken存储到Redis中，设置过期时间
7. 返回认证响应，包含Token和用户信息

#### 用户登录流程
1. 用户提交登录请求（用户名、密码）
2. Spring Security进行身份验证
3. 查询用户信息
4. 删除用户在Redis中现有的所有Token，确保单点登录
5. 生成新的JWT AccessToken和RefreshToken
6. 将新Token存储到Redis中
7. 返回认证响应，包含Token和用户信息

#### Token刷新流程
1. 用户提交刷新Token请求（RefreshToken）
2. 验证RefreshToken的有效性
3. 生成新的JWT AccessToken
4. 从新的AccessToken中提取用户名
5. 验证用户是否存在
6. 返回新的认证响应，包含新的AccessToken和原始RefreshToken

### 数据安全
- **密码加密**: BCrypt哈希加密
- **HTTPS**: 传输层安全
- **SQL注入防护**: MyBatis-Plus参数化查询
- **XSS防护**: 输入验证和输出编码
- **CSRF防护**: CSRF Token验证
- **敏感数据处理**: 对敏感信息进行脱敏处理

### 文件上传安全
- **文件类型验证**: 白名单文件类型
- **文件大小限制**: 防止大文件攻击
- **MinIO存储**: 安全的对象存储
- **存储隔离**: 文件存储路径隔离

## 📊 性能优化

### 前端性能优化
- **代码分割**: 按路由分割代码
- **懒加载**: 图片和组件懒加载
- **缓存策略**: 浏览器缓存和CDN缓存
- **图片优化**: WebP格式和响应式图片
- **Bundle优化**: Tree shaking和压缩

### 后端性能优化
- **数据库优化**: 索引优化和查询优化
- **缓存策略**: Redis缓存热点数据
- **连接池**: 数据库连接池管理
- **压缩**: Gzip压缩响应数据
- **CDN**: 静态资源CDN加速

### 数据库性能优化
- **索引优化**: 合理创建和使用索引
- **查询优化**: MyBatis-Plus查询优化
- **分页查询**: 大数据集分页处理
- **读写分离**: 主从数据库分离
- **连接池**: 数据库连接池配置

## 🚀 开发环境搭建

### 环境要求
- Java 21+
- Node.js 18+
- MySQL 8.0+
- Redis 7+
- MinIO
- Docker & Docker Compose

### 快速开始
```bash
# 克隆项目
git clone https://github.com/goldsunC/lifejourney.git
cd lifejourney

# 启动数据库和MinIO
docker-compose up -d mysql redis minio

# 后端启动
cd backend
./mvnw spring-boot:run

# 前端启动
cd frontend
npm install
npm run dev
```

## 📈 监控和日志

### 应用监控
- **错误监控**: Sentry错误追踪
- **性能监控**: 响应时间和吞吐量监控
- **用户行为**: 用户操作路径分析
- **系统资源**: CPU、内存、磁盘使用率

### 日志管理
- **结构化日志**: JSON格式日志
- **日志级别**: ERROR、WARN、INFO、DEBUG
- **日志聚合**: 集中式日志收集
- **日志分析**: 日志搜索和分析工具

## 🔄 CI/CD流程

### 持续集成
1. **代码提交**: Git提交触发CI
2. **代码检查**: ESLint、Checkstyle检查
3. **单元测试**: JUnit测试执行
4. **构建验证**: Maven/Gradle构建验证
5. **安全扫描**: 依赖安全扫描

### 持续部署
1. **分支策略**: main分支自动部署
2. **环境隔离**: 开发、测试、生产环境
3. **回滚机制**: 快速回滚到上一版本
4. **健康检查**: 部署后健康检查
5. **通知机制**: 部署状态通知

## 📚 开发规范

### 代码规范
- **Java**: 遵循阿里巴巴Java开发手册
- **TypeScript**: 严格类型检查
- **ESLint**: 代码质量检查
- **Prettier**: 代码格式化
- **Husky**: Git提交前检查
- **Conventional Commits**: 提交信息规范

### 文档规范
- **API文档**: Swagger/OpenAPI规范
- **代码注释**: JavaDoc注释规范
- **README**: 项目说明文档
- **CHANGELOG**: 版本变更记录

## 📝 附录

### 技术选型理由
- **Vue 3**: 现代化的前端框架，组合式API提供更好的开发体验
- **Spring Boot**: 成熟的Java企业级框架，生态丰富
- **Java 21**: 最新LTS版本，性能优化和语言特性
- **MySQL**: 成熟稳定的关系型数据库
- **Redis**: 高性能的内存数据库
- **MinIO**: 高性能的对象存储，兼容S3 API
- **TypeScript**: 提供类型安全和更好的开发体验

### 扩展性考虑
- **微服务架构**: 支持服务拆分和独立部署
- **插件系统**: 支持功能模块化扩展
- **主题系统**: 支持UI主题定制
- **多语言支持**: 国际化架构设计

### 维护性考虑
- **模块化设计**: 清晰的代码组织结构
- **测试覆盖**: 单元测试和集成测试
- **文档完善**: 详细的开发文档
- **代码审查**: 代码质量保证流程